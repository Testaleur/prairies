(function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))o(t);new MutationObserver(t=>{for(const s of t)if(s.type==="childList")for(const a of s.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&o(a)}).observe(document,{childList:!0,subtree:!0});function c(t){const s={};return t.integrity&&(s.integrity=t.integrity),t.referrerPolicy&&(s.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?s.credentials="include":t.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function o(t){if(t.ep)return;t.ep=!0;const s=c(t);fetch(t.href,s)}})();const k="#000",$=.5;var re=null,ne=null;function oe(e){re=e}function ae(e){ne=e}function se(){return re}function ie(){return ne}let le="FRANCE";function D(e){le=e}function z(){return le}const K={"01":"Auvergne-Rhône-Alpes","03":"Auvergne-Rhône-Alpes","07":"Auvergne-Rhône-Alpes",15:"Auvergne-Rhône-Alpes",26:"Auvergne-Rhône-Alpes",38:"Auvergne-Rhône-Alpes",42:"Auvergne-Rhône-Alpes",43:"Auvergne-Rhône-Alpes",63:"Auvergne-Rhône-Alpes",69:"Auvergne-Rhône-Alpes",73:"Auvergne-Rhône-Alpes",74:"Auvergne-Rhône-Alpes",21:"Bourgogne-Franche-Comté",25:"Bourgogne-Franche-Comté",39:"Bourgogne-Franche-Comté",58:"Bourgogne-Franche-Comté",70:"Bourgogne-Franche-Comté",71:"Bourgogne-Franche-Comté",89:"Bourgogne-Franche-Comté",90:"Bourgogne-Franche-Comté",22:"Bretagne",29:"Bretagne",35:"Bretagne",56:"Bretagne",18:"Centre-Val de Loire",28:"Centre-Val de Loire",36:"Centre-Val de Loire",37:"Centre-Val de Loire",41:"Centre-Val de Loire",45:"Centre-Val de Loire","2A":"Corse","2B":"Corse","08":"Grand Est",10:"Grand Est",51:"Grand Est",52:"Grand Est",54:"Grand Est",55:"Grand Est",57:"Grand Est",67:"Grand Est",68:"Grand Est",88:"Grand Est","02":"Hauts-de-France",59:"Hauts-de-France",60:"Hauts-de-France",62:"Hauts-de-France",80:"Hauts-de-France",75:"Île-de-France",77:"Île-de-France",78:"Île-de-France",91:"Île-de-France",92:"Île-de-France",93:"Île-de-France",94:"Île-de-France",95:"Île-de-France",14:"Normandie",27:"Normandie",50:"Normandie",61:"Normandie",76:"Normandie",16:"Nouvelle-Aquitaine",17:"Nouvelle-Aquitaine",19:"Nouvelle-Aquitaine",23:"Nouvelle-Aquitaine",24:"Nouvelle-Aquitaine",33:"Nouvelle-Aquitaine",40:"Nouvelle-Aquitaine",47:"Nouvelle-Aquitaine",64:"Nouvelle-Aquitaine",79:"Nouvelle-Aquitaine",86:"Nouvelle-Aquitaine",87:"Nouvelle-Aquitaine","09":"Occitanie",11:"Occitanie",12:"Occitanie",30:"Occitanie",31:"Occitanie",32:"Occitanie",34:"Occitanie",46:"Occitanie",48:"Occitanie",65:"Occitanie",66:"Occitanie",81:"Occitanie",82:"Occitanie",44:"Pays de la Loire",49:"Pays de la Loire",53:"Pays de la Loire",72:"Pays de la Loire",85:"Pays de la Loire","04":"Provence-Alpes-Côte d'Azur","05":"Provence-Alpes-Côte d'Azur","06":"Provence-Alpes-Côte d'Azur",13:"Provence-Alpes-Côte d'Azur",83:"Provence-Alpes-Côte d'Azur",84:"Provence-Alpes-Côte d'Azur"},me={84:"Auvergne-Rhône-Alpes",27:"Bourgogne-Franche-Comté",53:"Bretagne",24:"Centre-Val de Loire",94:"Corse",44:"Grand Est",32:"Hauts-de-France",11:"Île-de-France",28:"Normandie",75:"Nouvelle-Aquitaine",76:"Occitanie",52:"Pays de la Loire",93:"Provence-Alpes-Côte d'Azur"},ge={"01":"Ain","02":"Aisne","03":"Allier","04":"Alpes-de-Haute-Provence","05":"Hautes-Alpes","06":"Alpes-Maritimes","07":"Ardèche","08":"Ardennes","09":"Ariège",10:"Aube",11:"Aude",12:"Aveyron",13:"Bouches-du-Rhône",14:"Calvados",15:"Cantal",16:"Charente",17:"Charente-Maritime",18:"Cher",19:"Corrèze","2A":"Corse-du-Sud","2B":"Haute-Corse",21:"Côte-d'Or",22:"Côtes-d'Armor",23:"Creuse",24:"Dordogne",25:"Doubs",26:"Drôme",27:"Eure",28:"Eure-et-Loir",29:"Finistère",30:"Gard",31:"Haute-Garonne",32:"Gers",33:"Gironde",34:"Hérault",35:"Ille-et-Vilaine",36:"Indre",37:"Indre-et-Loire",38:"Isère",39:"Jura",40:"Landes",41:"Loir-et-Cher",42:"Loire",43:"Haute-Loire",44:"Loire-Atlantique",45:"Loiret",46:"Lot",47:"Lot-et-Garonne",48:"Lozère",49:"Maine-et-Loire",50:"Manche",51:"Marne",52:"Haute-Marne",53:"Mayenne",54:"Meurthe-et-Moselle",55:"Meuse",56:"Morbihan",57:"Moselle",58:"Nièvre",59:"Nord",60:"Oise",61:"Orne",62:"Pas-de-Calais",63:"Puy-de-Dôme",64:"Pyrénées-Atlantiques",65:"Hautes-Pyrénées",66:"Pyrénées-Orientales",67:"Bas-Rhin",68:"Haut-Rhin",69:"Rhône",70:"Haute-Saône",71:"Saône-et-Loire",72:"Sarthe",73:"Savoie",74:"Haute-Savoie",75:"Paris",76:"Seine-Maritime",77:"Seine-et-Marne",78:"Yvelines",79:"Deux-Sèvres",80:"Somme",81:"Tarn",82:"Tarn-et-Garonne",83:"Var",84:"Vaucluse",85:"Vendée",86:"Vienne",87:"Haute-Vienne",88:"Vosges",89:"Yonne",90:"Territoire de Belfort",91:"Essonne",92:"Hauts-de-Seine",93:"Seine-Saint-Denis",94:"Val-de-Marne",95:"Val-d'Oise"};function ce(e,r,c=-1/0,o=1/0){const t=new Map;return e.filter(a=>{if(r!=="ALL"&&a.CODE_CULTU!==r)return!1;const i=+a.alt_mean;return!(!isNaN(i)&&(i<c||i>o))}).forEach(a=>{const i=String(a.reg_parc||"").trim().split(".")[0],m=String(a.dep_parc||"").trim().padStart(2,"0"),x=String(a.arr_parc||"").trim().padStart(3,"0"),d=me[i],h=ge[m],f=+a.alt_mean||0,A=+a.SURF_PARC||0;Y(t,d,f,A),Y(t,h,f,A),Y(t,x,f,A)}),t.forEach(a=>a.avgAlt=a.count?Math.round(a.sumAlt/a.count):0),t}function Y(e,r,c,o){if(!r)return;e.has(r)||e.set(r,{count:0,sumAlt:0,surface:0});const t=e.get(r);t.count++,t.sumAlt+=c,t.surface+=Math.round(o)}function T(e,r,c){e.selectAll(".legend-group").remove();const o=e.append("g").attr("class","legend-group").attr("transform","translate(25, 140)");e.append("defs").append("linearGradient").attr("id","linear-gradient").attr("x1","0%").attr("y1","100%").attr("x2","0%").attr("y2","0%").selectAll("stop").data(d3.range(0,1.1,.1)).enter().append("stop").attr("offset",i=>`${i*100}%`).attr("stop-color",i=>d3.interpolateGreens(i)),o.append("rect").attr("width",20).attr("height",150).style("fill","url(#linear-gradient)");const a=d3.scaleLinear().domain([0,r]).range([150,0]);o.append("g").attr("transform","translate(20, 0)").call(d3.axisRight(a).ticks(5)),o.append("text").attr("y",-10).style("font-size","12px").style("font-weight","bold").text(c)}const fe={PPH:"Prairies permanentes",SPH:"Surfaces pastorales (herbe)",SPL:"Surfaces pastorales (fourrage)",CAE:"Châtaigneraie",CEE:"Chênaie"};let M=d3.select("#histogram-tooltip");M.empty()&&(M=d3.select("body").append("div").attr("id","histogram-tooltip").style("position","absolute").style("background","rgba(0,0,0,0.75)").style("color","#fff").style("padding","6px 10px").style("border-radius","4px").style("font-size","13px").style("pointer-events","none").style("opacity",0));function L(e,r="France"){d3.select("#histogram-section h3").text(`Répartition par type de prairie - ${r}`);const c=d3.select("#histogram-container"),o=c.node().clientWidth,t=350,s={top:20,right:30,bottom:100,left:60};c.selectAll("*").remove();const a=c.append("svg").attr("width",o).attr("height",t),i=e.map(d=>({type:fe[d.type]||d.type,count:d.count})),m=d3.scaleBand().domain(i.map(d=>d.type)).range([s.left,o-s.right]).padding(.3),x=d3.scaleLinear().domain([0,d3.max(i,d=>d.count)||1]).nice().range([t-s.bottom,s.top]);a.append("g").selectAll("rect").data(i).join("rect").attr("x",d=>m(d.type)).attr("y",d=>x(d.count)).attr("width",m.bandwidth()).attr("height",d=>x(0)-x(d.count)).attr("fill","#27ae60").style("cursor","pointer").on("mouseover",(d,h)=>{d3.select(d.currentTarget).attr("fill","#1e8449"),M.style("opacity",1).html(`<strong>${h.type}</strong><br/>${h.count.toLocaleString("fr-FR")} parcelles`)}).on("mousemove",d=>{M.style("left",d.pageX+12+"px").style("top",d.pageY-28+"px")}).on("mouseout",d=>{d3.select(d.currentTarget).attr("fill","#27ae60"),M.style("opacity",0)}),a.append("g").attr("transform",`translate(0,${t-s.bottom})`).call(d3.axisBottom(m)).selectAll("text").attr("transform","rotate(-25)").style("text-anchor","end").style("font-size","12px"),a.append("g").attr("transform",`translate(${s.left},0)`).call(d3.axisLeft(x).ticks(5))}let _=d3.select("#histogram-alti-tooltip");_.empty()&&(_=d3.select("body").append("div").attr("id","histogram-alti-tooltip").style("position","absolute").style("background","rgba(0,0,0,0.75)").style("color","#fff").style("padding","6px 10px").style("border-radius","4px").style("font-size","13px").style("pointer-events","none").style("opacity",0));function F(e,r="France"){d3.select("#histogram-alti-section h3").text(`Répartition par altitude - ${r}`);const c=d3.select("#histogram-alti-container"),o=c.node().clientWidth,t=350,s={top:20,right:30,bottom:60,left:60};c.selectAll("*").remove();const a=c.append("svg").attr("width",o).attr("height",t),i=200,m=e.map(n=>+n.alt_mean).filter(n=>!isNaN(n));if(m.length===0){a.append("text").attr("x",o/2).attr("y",t/2).attr("text-anchor","middle").style("fill","#999").text("Aucune donnée d'altitude disponible");return}const x=Math.floor(d3.min(m)/i)*i,d=Math.ceil(d3.max(m)/i)*i,h=[];for(let n=x;n<d;n+=i){const u=n+i,p=m.filter(v=>v>=n&&v<u).length;h.push({label:`${n}–${u}`,low:n,high:u,count:p})}const f=d3.scaleBand().domain(h.map(n=>n.label)).range([s.left,o-s.right]).padding(.2),A=d3.scaleLinear().domain([0,d3.max(h,n=>n.count)||1]).nice().range([t-s.bottom,s.top]);a.append("g").selectAll("rect").data(h).join("rect").attr("x",n=>f(n.label)).attr("y",n=>A(n.count)).attr("width",f.bandwidth()).attr("height",n=>A(0)-A(n.count)).attr("fill","#27ae60").style("cursor","pointer").on("mouseover",(n,u)=>{d3.select(n.currentTarget).attr("fill","#1e8449"),_.style("opacity",1).html(`<strong>${u.label} m</strong><br/>${u.count.toLocaleString("fr-FR")} parcelles`)}).on("mousemove",n=>{_.style("left",n.pageX+12+"px").style("top",n.pageY-28+"px")}).on("mouseout",n=>{d3.select(n.currentTarget).attr("fill","#27ae60"),_.style("opacity",0)}),a.append("g").attr("transform",`translate(0,${t-s.bottom})`).call(d3.axisBottom(f)).selectAll("text").attr("transform","rotate(-25)").style("text-anchor","end").style("font-size","11px"),a.append("g").attr("transform",`translate(${s.left},0)`).call(d3.axisLeft(A).ticks(5)),a.append("text").attr("transform","rotate(-90)").attr("x",-175).attr("y",15).attr("text-anchor","middle").style("font-size","11px").style("fill","#555").text("Nombre de parcelles")}function H(e,r,c,o,t=.8){const[[s,a],[i,m]]=e.bounds(o);r.transition().duration(750).call(c.transform,d3.zoomIdentity.translate(r.node().getBoundingClientRect().width/2,r.node().getBoundingClientRect().height/2).scale(Math.min(40,t/Math.max((i-s)/r.node().getBoundingClientRect().width,(m-a)/r.node().getBoundingClientRect().height))).translate(-(s+i)/2,-(a+m)/2))}function ye(e,r,c,o,t,s,a,i,m,x,d,h,f,A,n){if(oe(r),D("REGION"),h.style("display","block").text("← Retour à la France"),e&&e.stopPropagation(),H(c,o,t,r,.7),de(r.properties.nom,s,a,i,m,o,c,d,x,h,t,f,A),window.allParcellesData){const u=String(r.properties.code),p=window.allParcellesData.filter(g=>String(g.reg_parc).split(".")[0]===u),v=d3.rollup(p,g=>g.length,g=>g.CODE_CULTU);L(Array.from(v,([g,l])=>({type:g,count:l})),r.properties.nom),F(p,r.properties.nom)}}function he(e,r,c,o,t,s,a,i,m,x,d){if(ae(r),D("DEPARTEMENT"),e.stopPropagation(),c.text("← Retour à la Région"),H(o,t,s,r,.8),pe(r.properties.code,c,d,a,i,m,t,o,x,s),window.allParcellesData){const h=String(parseInt(r.properties.code)),f=window.allParcellesData.filter(n=>String(parseInt(n.dep_parc))===h),A=d3.rollup(f,n=>n.length,n=>n.CODE_CULTU);L(Array.from(A,([n,u])=>({type:n,count:u})),r.properties.nom),F(f,r.properties.nom)}}function Ae(e,r,c,o,t,s,a){D("ARRONDISSEMENT"),e.stopPropagation(),c.text("← Retour au Département"),H(o,t,s,r,.9),a.selectAll("path").transition().duration(750).style("opacity",i=>i===r?1:.1)}let Z=new Map;function Q(){return Z}function xe(e,r,c,o,t,s,a,i,m,x,d){Z=o;function h(){const u=+document.getElementById("alt-min-slider").value,p=+document.getElementById("alt-max-slider").value;return[u,p]}function f(){const u=document.getElementById("prairie-type-select").value,p=document.getElementById("affichage-type-select").value,[v,g]=h();o=ce(r,u,v,g),Z=o;const l=p==="NB"?"count":"surface",E=e.max(c,N=>o.get(N)?.[l])||1,b=e.scaleSequential().domain([0,E]).interpolator(e.interpolateGreens),y=p==="NB"?"Nombre de prairies":"Surface de prairies (ha)",w=z(),B=se();if(B){const N=B.properties.nom,S=s.features.filter(q=>a[q.properties.code]===N);var R=e.max(S,q=>o.get(q.properties.nom.trim())?.[l])||1,G=e.scaleSequential().domain([0,R]).interpolator(e.interpolateGreens)}const P=ie();if(P){const N=x.features.filter(S=>S.properties.code.slice(0,2)===P.properties.code);var U=e.max(N,S=>o.get(S.properties.code)?.[l])||1,j=e.scaleSequential().domain([0,U]).interpolator(e.interpolateGreens)}if(w==="REGION"?(T(i,R,y),te(m,o,G,l),W(t,o,b,l)):w==="DEPARTEMENT"?(T(i,U,y),W(t,o,b,l),te(m,o,G,l),ve(d,o,j,l)):(T(i,E,y),W(t,o,b,l)),!window.allParcellesData)return;const C=window.allParcellesData.filter(N=>{const S=+N.alt_mean;return!isNaN(S)&&S>=v&&S<=g});let I=C,V="France";if(w==="REGION"&&B){const N=String(B.properties.code);I=C.filter(S=>String(S.reg_parc).split(".")[0]===N),V=B.properties.nom}else if((w==="DEPARTEMENT"||w==="ARRONDISSEMENT")&&P){const N=String(parseInt(P.properties.code));I=C.filter(S=>String(parseInt(S.dep_parc))===N),V=P.properties.nom}const ee=u==="ALL"?I:I.filter(N=>N.CODE_CULTU===u),ue=e.rollup(ee,N=>N.length,N=>N.CODE_CULTU);L(Array.from(ue,([N,S])=>({type:N,count:S})),V),F(ee,V)}e.select("#prairie-type-select").on("change",f),e.select("#affichage-type-select").on("change",f);const A=e.select("#alt-min-slider"),n=e.select("#alt-max-slider");A.on("input",function(){let u=+this.value,p=+n.property("value");u>p&&(u=p,this.value=u),document.getElementById("alt-min-display").innerText=u,X(),f()}),n.on("input",function(){let u=+this.value,p=+A.property("value");u<p&&(u=p,this.value=u),document.getElementById("alt-max-display").innerText=u,X(),f()}),X()}function W(e,r,c,o){e.selectAll("path").transition().duration(500).attr("fill",t=>c(r.get(t.properties.nom.trim())?.[o]||0))}function te(e,r,c,o){e.selectAll("path").transition().duration(500).attr("fill",t=>c(r.get(t.properties.nom.trim())?.[o]||0))}function ve(e,r,c,o){e.selectAll("path").transition().duration(500).attr("fill",t=>c(r.get(t.properties.code)?.[o]||0))}function X(){const e=document.getElementById("alt-min-slider"),r=document.getElementById("alt-max-slider"),c=document.querySelector(".slider-track");if(!e||!r||!c)return;const o=parseFloat(e.min),t=parseFloat(e.max),s=(e.value-o)/(t-o)*100,a=(r.value-o)/(t-o)*100;c.style.background=`linear-gradient(to right,
    #ddd ${s}%,
    #27ae60 ${s}%,
    #27ae60 ${a}%,
    #ddd ${a}%
  )`}function Ce(e,r,c,o,t,s,a,i,m,x,d,h,f,A){const n=document.getElementById("affichage-type-select").value==="NB"?"count":"surface",u=d3.formatLocale({decimal:",",thousands:" ",grouping:[3],currency:[""," €"]}).format(",");e.selectAll("path").data(r.features).enter().append("path").attr("d",t).style("vector-effect","non-scaling-stroke").attr("fill",p=>s(c.get(p.properties.nom.trim())?.[n]||0)).attr("stroke",k).attr("stroke-width",$).on("mouseover",(p,v)=>{const g=v.properties.nom,l=Q().get(g.trim());a.style("opacity",1).html(`
        <strong>Région :</strong> ${g}<br/>
        <strong>Nombre de prairies :</strong> ${l?u(l.count):0}<br/>
        <strong>Surface de prairies :</strong> ${l?u(l.surface):0} ha<br/>
        <strong>Altitude moy. :</strong> ${l?l.avgAlt:0} m
        `),d3.select(p.currentTarget).attr("stroke","#000").attr("stroke-width",1.5).raise()}).on("mousemove",p=>{a.style("left",p.pageX+10+"px").style("top",p.pageY+10+"px")}).on("mouseout",p=>{a.style("opacity",0),d3.select(p.currentTarget).attr("stroke",k).attr("stroke-width",$)}).on("click",(p,v)=>ye(p,v,t,o,i,e,m,K,c,a,x,d,h,f))}function de(e,r,c,o,t,s,a,i,m,x,d,h,f){r.selectAll("path").transition().duration(500).style("opacity",0).style("pointer-events","none");const A=c.features.filter(y=>o[y.properties.code]===e),n=d3.max(A,y=>t.get(y.properties.nom.trim())?.count)||1,u=d3.max(A,y=>t.get(y.properties.nom.trim())?.surface)||1,p=document.getElementById("affichage-type-select").value,v=p==="NB"?n:u,g=p==="NB"?"Nombre de prairies":"Surface de prairies (ha)",l=p==="NB"?"count":"surface",E=d3.scaleSequential().domain([0,v]).interpolator(d3.interpolateGreens);T(s,v,g),i.selectAll("path").data(A,y=>y.properties.nom).join("path").attr("d",a).style("vector-effect","non-scaling-stroke").style("pointer-events","all").attr("fill",y=>E(t.get(y.properties.nom.trim())?.[l]||0)).attr("stroke",k).attr("stroke-width",$).style("opacity",0).on("mouseover",(y,w)=>{const B=w.properties.nom,R=Q().get(B.trim());m.style("opacity",1).html(`
        <div style="font-weight:bold; font-size:15px;">${B}</div>
        <hr>
        <div><strong>Nombre de prairies :</strong> ${R?R.count:0}</div>
        <strong>Surface de prairies :</strong> ${R?R.surface:0} ha<br/>
        <div><strong>Altitude moy. :</strong> ${R?R.avgAlt:0} m</div>
      `),d3.select(y.currentTarget).attr("stroke","#000").attr("stroke-width",1.5).raise()}).on("mousemove",y=>{m.style("left",y.pageX+15+"px").style("top",y.pageY+15+"px")}).on("mouseout",y=>{m.style("opacity",0),d3.select(y.currentTarget).attr("stroke",k).attr("stroke-width",$)}).on("click",(y,w)=>{he(y,w,x,a,s,d,h,f,t,m,i)}).transition().duration(500).style("opacity",1)}function pe(e,r,c,o,t,s,a,i,m,x){c.selectAll("path").transition().duration(500).style("opacity",0).style("pointer-events","none");const d=t.features.filter(l=>l.properties.code.startsWith(e)),h=d3.max(d,l=>s.get(l.properties.code)?.count)||1,f=d3.max(d,l=>s.get(l.properties.code)?.surface)||1,A=document.getElementById("affichage-type-select").value,n=A==="NB"?h:f,u=A==="NB"?"Nombre de prairies":"Surface de prairies (ha)",p=A==="NB"?"count":"surface",v=d3.scaleSequential().domain([0,n]).interpolator(d3.interpolateGreens);T(a,n,u),o.selectAll("path").data(d,l=>l.properties.code).enter().append("path").attr("d",i).style("vector-effect","non-scaling-stroke").attr("fill",l=>{const E=s.get(l.properties.code);return v(E?E[p]:0)}).attr("stroke",k).attr("stroke-width",$).style("opacity",0).on("mouseover",(l,E)=>{const b=E.properties.code,y=Q().get(b);m.style("opacity",1).html(`
        <div style="font-weight:bold; font-size:15px;">${b}</div>
        <hr>
        <div><strong>Nombre de prairies :</strong> ${y?y.count:0}</div>
        <div><strong>Surface de prairies :</strong> ${y?y.surface:0} ha</div>
        <div><strong>Altitude moy. :</strong> ${y?y.avgAlt:0} m</div>
      `),d3.select(l.currentTarget).attr("stroke","#000").attr("stroke-width",1.5).raise()}).on("mousemove",l=>{m.style("left",l.pageX+15+"px").style("top",l.pageY+15+"px")}).on("mouseout",l=>{m.style("opacity",0),d3.select(l.currentTarget).attr("stroke",k).attr("stroke-width",$)}).on("click",(l,E)=>Ae(l,E,r,i,a,x,o)).transition().duration(500).style("opacity",1)}function Ee(e,r,c,o,t,s,a,i,m,x,d,h){const f=d3.select("#map-container").append("button").attr("id","back-button").text("← Retour à la France").style("position","absolute").style("top","70px").style("left","20px").style("display","none").style("z-index","1000").on("click",()=>A());function A(){if(z()==="ARRONDISSEMENT"){D("DEPARTEMENT"),f.text("← Retour à la Région"),e.selectAll("path").remove();const n=ie();if(n&&(pe(n.properties.code,f,r,e,h,x,a,s,d,i),window.allParcellesData)){const u=String(parseInt(n.properties.code)),p=window.allParcellesData.filter(g=>String(parseInt(g.dep_parc))===u),v=d3.rollup(p,g=>g.length,g=>g.CODE_CULTU);L(Array.from(v,([g,l])=>({type:g,count:l})),n.properties.nom),F(p,n.properties.nom)}H(s,a,i,n,.9)}else if(z()==="DEPARTEMENT"){D("REGION"),f.text("← Retour à la France"),e.selectAll("path").remove();const n=se();if(n&&(de(n.properties.nom,o,c,t,x,a,s,r,d,f,i,e,h),window.allParcellesData)){const u=String(n.properties.code),p=window.allParcellesData.filter(g=>String(g.reg_parc).split(".")[0]===u),v=d3.rollup(p,g=>g.length,g=>g.CODE_CULTU);L(Array.from(v,([g,l])=>({type:g,count:l})),n.properties.nom),F(p,n.properties.nom)}H(s,a,i,n,.8),ae(null)}else if(z()==="REGION"){D("FRANCE"),f.style("display","none"),e.selectAll("path").remove(),r.selectAll("path").remove();const n=d3.max(m,l=>x.get(l)?.count)||100,u=d3.max(m,l=>x.get(l)?.surface)||100,p=document.getElementById("affichage-type-select").value;if(T(a,p==="NB"?n:u,p==="NB"?"Nombre de prairies":"Surface de prairies (ha)"),window.allParcellesData){const l=d3.rollup(window.allParcellesData,E=>E.length,E=>E.CODE_CULTU);L(Array.from(l,([E,b])=>({type:E,count:b})),"France"),F(window.allParcellesData,"France")}o.selectAll("path").transition().duration(500).style("opacity",1).style("pointer-events","all"),a.transition().duration(750).call(i.transform,d3.zoomIdentity),oe(null)}}return f}let J=[],O=new Map;function Ne(e,r,c,o){const t="/prairies/";Promise.all([d3.json(`${t}regions.geojson`),d3.json(`${t}departements.geojson`),d3.json(`${t}arrondissements.geojson`),d3.csv(`${t}parcelles.csv`)]).then(([s,a,i,m])=>{J=m,window.allParcellesData=m;const x=m.map(C=>+C.alt_mean).filter(C=>!isNaN(C)),d=Math.floor(d3.min(x)||0),h=Math.ceil(d3.max(x)||3e3),f=document.getElementById("alt-min-slider"),A=document.getElementById("alt-max-slider");f.min=d,f.max=h,f.value=d,A.min=d,A.max=h,A.value=h,document.getElementById("alt-min-display").innerText=d,document.getElementById("alt-max-display").innerText=h,O=ce(J,"ALL",d,h);const n=s.features.map(C=>C.properties.nom.trim()),u=d3.max(n,C=>O.get(C)?.count)||100,p=d3.max(n,C=>O.get(C)?.surface)||100,v=document.getElementById("affichage-type-select").value,g=v==="NB"?u:p,l=v==="NB"?"Nombre de prairies":"Surface de prairies (ha)",E=d3.geoConicConformal().center([2.2137,46.2276]).scale(3e3).translate([c/2,o/2]),b=d3.geoPath().projection(E),y=e.append("g"),w=y.append("g").attr("class","arr-layer"),B=y.append("g").attr("class","depts-layer"),R=y.append("g").attr("class","regions-layer"),G=d3.zoom().scaleExtent([1,40]).on("zoom",C=>y.attr("transform",C.transform)),P=d3.scaleSequential().domain([0,g]).interpolator(d3.interpolateGreens),U=Ee(w,B,a,R,K,b,e,G,n,O,r,i);T(e,g,l),xe(d3,J,n,O,R,a,K,e,B,i,w);const j=d3.rollup(m,C=>C.length,C=>C.CODE_CULTU);L(Array.from(j,([C,I])=>({type:C,count:I})),"France"),F(m,"France"),Ce(R,s,O,e,b,P,r,G,a,B,U,w,i)})}window.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("map-container"),r=e.clientWidth,c=e.clientHeight,o=d3.select("#map").append("svg").attr("width",r).attr("height",c),t=d3.select("#tooltip");Ne(o,t,r,c)});
