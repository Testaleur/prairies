(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))o(t);new MutationObserver(t=>{for(const s of t)if(s.type==="childList")for(const a of s.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&o(a)}).observe(document,{childList:!0,subtree:!0});function l(t){const s={};return t.integrity&&(s.integrity=t.integrity),t.referrerPolicy&&(s.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?s.credentials="include":t.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function o(t){if(t.ep)return;t.ep=!0;const s=l(t);fetch(t.href,s)}})();const k="#000",$=.5;var re=null,ne=null;function oe(e){re=e}function ae(e){ne=e}function se(){return re}function ie(){return ne}let le="FRANCE";function M(e){le=e}function j(){return le}const Z={"01":"Auvergne-Rhône-Alpes","03":"Auvergne-Rhône-Alpes","07":"Auvergne-Rhône-Alpes",15:"Auvergne-Rhône-Alpes",26:"Auvergne-Rhône-Alpes",38:"Auvergne-Rhône-Alpes",42:"Auvergne-Rhône-Alpes",43:"Auvergne-Rhône-Alpes",63:"Auvergne-Rhône-Alpes",69:"Auvergne-Rhône-Alpes",73:"Auvergne-Rhône-Alpes",74:"Auvergne-Rhône-Alpes",21:"Bourgogne-Franche-Comté",25:"Bourgogne-Franche-Comté",39:"Bourgogne-Franche-Comté",58:"Bourgogne-Franche-Comté",70:"Bourgogne-Franche-Comté",71:"Bourgogne-Franche-Comté",89:"Bourgogne-Franche-Comté",90:"Bourgogne-Franche-Comté",22:"Bretagne",29:"Bretagne",35:"Bretagne",56:"Bretagne",18:"Centre-Val de Loire",28:"Centre-Val de Loire",36:"Centre-Val de Loire",37:"Centre-Val de Loire",41:"Centre-Val de Loire",45:"Centre-Val de Loire","2A":"Corse","2B":"Corse","08":"Grand Est",10:"Grand Est",51:"Grand Est",52:"Grand Est",54:"Grand Est",55:"Grand Est",57:"Grand Est",67:"Grand Est",68:"Grand Est",88:"Grand Est","02":"Hauts-de-France",59:"Hauts-de-France",60:"Hauts-de-France",62:"Hauts-de-France",80:"Hauts-de-France",75:"Île-de-France",77:"Île-de-France",78:"Île-de-France",91:"Île-de-France",92:"Île-de-France",93:"Île-de-France",94:"Île-de-France",95:"Île-de-France",14:"Normandie",27:"Normandie",50:"Normandie",61:"Normandie",76:"Normandie",16:"Nouvelle-Aquitaine",17:"Nouvelle-Aquitaine",19:"Nouvelle-Aquitaine",23:"Nouvelle-Aquitaine",24:"Nouvelle-Aquitaine",33:"Nouvelle-Aquitaine",40:"Nouvelle-Aquitaine",47:"Nouvelle-Aquitaine",64:"Nouvelle-Aquitaine",79:"Nouvelle-Aquitaine",86:"Nouvelle-Aquitaine",87:"Nouvelle-Aquitaine","09":"Occitanie",11:"Occitanie",12:"Occitanie",30:"Occitanie",31:"Occitanie",32:"Occitanie",34:"Occitanie",46:"Occitanie",48:"Occitanie",65:"Occitanie",66:"Occitanie",81:"Occitanie",82:"Occitanie",44:"Pays de la Loire",49:"Pays de la Loire",53:"Pays de la Loire",72:"Pays de la Loire",85:"Pays de la Loire","04":"Provence-Alpes-Côte d'Azur","05":"Provence-Alpes-Côte d'Azur","06":"Provence-Alpes-Côte d'Azur",13:"Provence-Alpes-Côte d'Azur",83:"Provence-Alpes-Côte d'Azur",84:"Provence-Alpes-Côte d'Azur"},me={84:"Auvergne-Rhône-Alpes",27:"Bourgogne-Franche-Comté",53:"Bretagne",24:"Centre-Val de Loire",94:"Corse",44:"Grand Est",32:"Hauts-de-France",11:"Île-de-France",28:"Normandie",75:"Nouvelle-Aquitaine",76:"Occitanie",52:"Pays de la Loire",93:"Provence-Alpes-Côte d'Azur"},ge={"01":"Ain","02":"Aisne","03":"Allier","04":"Alpes-de-Haute-Provence","05":"Hautes-Alpes","06":"Alpes-Maritimes","07":"Ardèche","08":"Ardennes","09":"Ariège",10:"Aube",11:"Aude",12:"Aveyron",13:"Bouches-du-Rhône",14:"Calvados",15:"Cantal",16:"Charente",17:"Charente-Maritime",18:"Cher",19:"Corrèze","2A":"Corse-du-Sud","2B":"Haute-Corse",21:"Côte-d'Or",22:"Côtes-d'Armor",23:"Creuse",24:"Dordogne",25:"Doubs",26:"Drôme",27:"Eure",28:"Eure-et-Loir",29:"Finistère",30:"Gard",31:"Haute-Garonne",32:"Gers",33:"Gironde",34:"Hérault",35:"Ille-et-Vilaine",36:"Indre",37:"Indre-et-Loire",38:"Isère",39:"Jura",40:"Landes",41:"Loir-et-Cher",42:"Loire",43:"Haute-Loire",44:"Loire-Atlantique",45:"Loiret",46:"Lot",47:"Lot-et-Garonne",48:"Lozère",49:"Maine-et-Loire",50:"Manche",51:"Marne",52:"Haute-Marne",53:"Mayenne",54:"Meurthe-et-Moselle",55:"Meuse",56:"Morbihan",57:"Moselle",58:"Nièvre",59:"Nord",60:"Oise",61:"Orne",62:"Pas-de-Calais",63:"Puy-de-Dôme",64:"Pyrénées-Atlantiques",65:"Hautes-Pyrénées",66:"Pyrénées-Orientales",67:"Bas-Rhin",68:"Haut-Rhin",69:"Rhône",70:"Haute-Saône",71:"Saône-et-Loire",72:"Sarthe",73:"Savoie",74:"Haute-Savoie",75:"Paris",76:"Seine-Maritime",77:"Seine-et-Marne",78:"Yvelines",79:"Deux-Sèvres",80:"Somme",81:"Tarn",82:"Tarn-et-Garonne",83:"Var",84:"Vaucluse",85:"Vendée",86:"Vienne",87:"Haute-Vienne",88:"Vosges",89:"Yonne",90:"Territoire de Belfort",91:"Essonne",92:"Hauts-de-Seine",93:"Seine-Saint-Denis",94:"Val-de-Marne",95:"Val-d'Oise"};function ce(e,n,l=-1/0,o=1/0){const t=new Map;return e.filter(a=>{if(n!=="ALL"&&a.CODE_CULTU!==n)return!1;const i=+a.alt_mean;return!(!isNaN(i)&&(i<l||i>o))}).forEach(a=>{const i=String(a.reg_parc||"").trim().split(".")[0],u=String(a.dep_parc||"").trim().padStart(2,"0"),x=String(a.arr_parc||"").trim().padStart(3,"0"),c=me[i],y=ge[u],f=+a.alt_mean||0,v=+a.SURF_PARC||0;W(t,c,f,v),W(t,y,f,v),W(t,x,f,v)}),t.forEach(a=>a.avgAlt=a.count?Math.round(a.sumAlt/a.count):0),t}function W(e,n,l,o){if(!n)return;e.has(n)||e.set(n,{count:0,sumAlt:0,surface:0});const t=e.get(n);t.count++,t.sumAlt+=l,t.surface+=Math.round(o)}function L(e,n,l){e.selectAll(".legend-group").remove();const o=e.append("g").attr("class","legend-group").attr("transform","translate(25, 140)");e.append("defs").append("linearGradient").attr("id","linear-gradient").attr("x1","0%").attr("y1","100%").attr("x2","0%").attr("y2","0%").selectAll("stop").data(d3.range(0,1.1,.1)).enter().append("stop").attr("offset",i=>`${i*100}%`).attr("stop-color",i=>d3.interpolateGreens(i)),o.append("rect").attr("width",20).attr("height",150).style("fill","url(#linear-gradient)");const a=d3.scaleLinear().domain([0,n]).range([150,0]);o.append("g").attr("transform","translate(20, 0)").call(d3.axisRight(a).ticks(5)),o.append("text").attr("y",-10).style("font-size","12px").style("font-weight","bold").text(l)}const fe={PPH:"Prairies permanentes",SPH:"Surfaces pastorales (herbe)",SPL:"Surfaces pastorales (fourrage)",CAE:"Châtaigneraie",CEE:"Chênaie"};let G=d3.select("#histogram-tooltip");G.empty()&&(G=d3.select("body").append("div").attr("id","histogram-tooltip").style("position","absolute").style("background","rgba(0,0,0,0.75)").style("color","#fff").style("padding","6px 10px").style("border-radius","4px").style("font-size","13px").style("pointer-events","none").style("opacity",0));function F(e,n="France"){d3.select("#histogram-section h3").text(`Répartition par type de prairie - ${n}`);const l=d3.select("#histogram-container"),o=l.node().clientWidth,t=350,s={top:20,right:30,bottom:100,left:60};l.selectAll("*").remove();const a=l.append("svg").attr("width",o).attr("height",t),i=e.map(c=>({type:fe[c.type]||c.type,count:c.count})),u=d3.scaleBand().domain(i.map(c=>c.type)).range([s.left,o-s.right]).padding(.3),x=d3.scaleLinear().domain([0,d3.max(i,c=>c.count)||1]).nice().range([t-s.bottom,s.top]);a.append("g").selectAll("rect").data(i).join("rect").attr("x",c=>u(c.type)).attr("y",c=>x(c.count)).attr("width",u.bandwidth()).attr("height",c=>x(0)-x(c.count)).attr("fill","#27ae60").style("cursor","pointer").on("mouseover",(c,y)=>{d3.select(c.currentTarget).attr("fill","#1e8449"),G.style("opacity",1).html(`<strong>${y.type}</strong><br/>${y.count.toLocaleString("fr-FR")} parcelles`)}).on("mousemove",c=>{G.style("left",c.pageX+12+"px").style("top",c.pageY-28+"px")}).on("mouseout",c=>{d3.select(c.currentTarget).attr("fill","#27ae60"),G.style("opacity",0)}),a.append("g").attr("transform",`translate(0,${t-s.bottom})`).call(d3.axisBottom(u)).selectAll("text").attr("transform","rotate(-25)").style("text-anchor","end").style("font-size","12px"),a.append("g").attr("transform",`translate(${s.left},0)`).call(d3.axisLeft(x).ticks(5))}let _=d3.select("#histogram-alti-tooltip");_.empty()&&(_=d3.select("body").append("div").attr("id","histogram-alti-tooltip").style("position","absolute").style("background","rgba(0,0,0,0.75)").style("color","#fff").style("padding","6px 10px").style("border-radius","4px").style("font-size","13px").style("pointer-events","none").style("opacity",0));function I(e,n="France"){d3.select("#histogram-alti-section h3").text(`Répartition par altitude - ${n}`);const l=d3.select("#histogram-alti-container"),o=l.node().clientWidth,t=350,s={top:20,right:30,bottom:60,left:60};l.selectAll("*").remove();const a=l.append("svg").attr("width",o).attr("height",t),i=200,u=e.map(r=>+r.alt_mean).filter(r=>!isNaN(r));if(u.length===0){a.append("text").attr("x",o/2).attr("y",t/2).attr("text-anchor","middle").style("fill","#999").text("Aucune donnée d'altitude disponible");return}const x=Math.floor(d3.min(u)/i)*i,c=Math.ceil(d3.max(u)/i)*i,y=[];for(let r=x;r<c;r+=i){const d=r+i,p=u.filter(C=>C>=r&&C<d).length;y.push({label:`${r}–${d}`,low:r,high:d,count:p})}const f=d3.scaleBand().domain(y.map(r=>r.label)).range([s.left,o-s.right]).padding(.2),v=d3.scaleLinear().domain([0,d3.max(y,r=>r.count)||1]).nice().range([t-s.bottom,s.top]);a.append("g").selectAll("rect").data(y).join("rect").attr("x",r=>f(r.label)).attr("y",r=>v(r.count)).attr("width",f.bandwidth()).attr("height",r=>v(0)-v(r.count)).attr("fill","#27ae60").style("cursor","pointer").on("mouseover",(r,d)=>{d3.select(r.currentTarget).attr("fill","#1e8449"),_.style("opacity",1).html(`<strong>${d.label} m</strong><br/>${d.count.toLocaleString("fr-FR")} parcelles`)}).on("mousemove",r=>{_.style("left",r.pageX+12+"px").style("top",r.pageY-28+"px")}).on("mouseout",r=>{d3.select(r.currentTarget).attr("fill","#27ae60"),_.style("opacity",0)}),a.append("g").attr("transform",`translate(0,${t-s.bottom})`).call(d3.axisBottom(f)).selectAll("text").attr("transform","rotate(-25)").style("text-anchor","end").style("font-size","11px"),a.append("g").attr("transform",`translate(${s.left},0)`).call(d3.axisLeft(v).ticks(5)),a.append("text").attr("transform","rotate(-90)").attr("x",-175).attr("y",15).attr("text-anchor","middle").style("font-size","11px").style("fill","#555").text("Nombre de parcelles")}function H(e,n,l,o,t=.8){const[[s,a],[i,u]]=e.bounds(o);n.transition().duration(750).call(l.transform,d3.zoomIdentity.translate(n.node().getBoundingClientRect().width/2,n.node().getBoundingClientRect().height/2).scale(Math.min(40,t/Math.max((i-s)/n.node().getBoundingClientRect().width,(u-a)/n.node().getBoundingClientRect().height))).translate(-(s+i)/2,-(a+u)/2))}function ye(e,n,l,o,t,s,a,i,u,x,c,y,f,v,r){if(oe(n),M("REGION"),y.style("display","block").text("← Retour à la France"),e&&e.stopPropagation(),H(l,o,t,n,.7),de(n.properties.nom,s,a,i,u,o,l,c,x,y,t,f,v),window.allParcellesData){const d=String(n.properties.code),p=window.allParcellesData.filter(m=>String(m.reg_parc).split(".")[0]===d),C=d3.rollup(p,m=>m.length,m=>m.CODE_CULTU);F(Array.from(C,([m,h])=>({type:m,count:h})),n.properties.nom),I(p,n.properties.nom)}}function he(e,n,l,o,t,s,a,i,u,x,c){if(ae(n),M("DEPARTEMENT"),e.stopPropagation(),l.text("← Retour à la Région"),H(o,t,s,n,.8),pe(n.properties.code,l,c,a,i,u,t,o,x,s),window.allParcellesData){const y=String(parseInt(n.properties.code)),f=window.allParcellesData.filter(r=>String(parseInt(r.dep_parc))===y),v=d3.rollup(f,r=>r.length,r=>r.CODE_CULTU);F(Array.from(v,([r,d])=>({type:r,count:d})),n.properties.nom),I(f,n.properties.nom)}}function Ae(e,n,l,o,t,s,a){M("ARRONDISSEMENT"),e.stopPropagation(),l.text("← Retour au Département"),H(o,t,s,n,.9),a.selectAll("path").transition().duration(750).style("opacity",i=>i===n?1:.1)}let Q=new Map;function U(){return Q}function xe(e,n,l,o,t,s,a,i,u,x,c){Q=o;function y(){const d=+document.getElementById("alt-min-slider").value,p=+document.getElementById("alt-max-slider").value;return[d,p]}function f(){const d=document.getElementById("prairie-type-select").value,p=document.getElementById("affichage-type-select").value,[C,m]=y();o=ce(n,d,C,m),Q=o;const h=p==="NB"?"count":"surface",A=e.max(l,N=>o.get(N)?.[h])||1,w=e.scaleSequential().domain([0,A]).interpolator(e.interpolateGreens),b=p==="NB"?"Nombre de prairies":"Surface de prairies (ha)",g=j(),R=se();if(R){const N=R.properties.nom,S=s.features.filter(z=>a[z.properties.code]===N);var P=e.max(S,z=>o.get(z.properties.nom.trim())?.[h])||1,B=e.scaleSequential().domain([0,P]).interpolator(e.interpolateGreens)}const T=ie();if(T){const N=x.features.filter(S=>S.properties.code.slice(0,2)===T.properties.code);var V=e.max(N,S=>o.get(S.properties.code)?.[h])||1,Y=e.scaleSequential().domain([0,V]).interpolator(e.interpolateGreens)}if(g==="REGION"?(L(i,P,b),te(u,o,B,h),X(t,o,w,h)):g==="DEPARTEMENT"?(L(i,V,b),X(t,o,w,h),te(u,o,B,h),ve(c,o,Y,h)):(L(i,A,b),X(t,o,w,h)),!window.allParcellesData)return;const E=window.allParcellesData.filter(N=>{const S=+N.alt_mean;return!isNaN(S)&&S>=C&&S<=m});let O=E,q="France";if(g==="REGION"&&R){const N=String(R.properties.code);O=E.filter(S=>String(S.reg_parc).split(".")[0]===N),q=R.properties.nom}else if((g==="DEPARTEMENT"||g==="ARRONDISSEMENT")&&T){const N=String(parseInt(T.properties.code));O=E.filter(S=>String(parseInt(S.dep_parc))===N),q=T.properties.nom}const ee=d==="ALL"?O:O.filter(N=>N.CODE_CULTU===d),ue=e.rollup(ee,N=>N.length,N=>N.CODE_CULTU);F(Array.from(ue,([N,S])=>({type:N,count:S})),q),I(ee,q)}e.select("#prairie-type-select").on("change",f),e.select("#affichage-type-select").on("change",f);const v=e.select("#alt-min-slider"),r=e.select("#alt-max-slider");v.on("input",function(){let d=+this.value,p=+r.property("value");d>p&&(d=p,this.value=d),document.getElementById("alt-min-display").innerText=d,J(),f()}),r.on("input",function(){let d=+this.value,p=+v.property("value");d<p&&(d=p,this.value=d),document.getElementById("alt-max-display").innerText=d,J(),f()}),J()}function X(e,n,l,o){e.selectAll("path").transition().duration(500).attr("fill",t=>l(n.get(t.properties.nom.trim())?.[o]||0))}function te(e,n,l,o){e.selectAll("path").transition().duration(500).attr("fill",t=>l(n.get(t.properties.nom.trim())?.[o]||0))}function ve(e,n,l,o){e.selectAll("path").transition().duration(500).attr("fill",t=>l(n.get(t.properties.code)?.[o]||0))}function J(){const e=document.getElementById("alt-min-slider"),n=document.getElementById("alt-max-slider"),l=document.querySelector(".slider-track");if(!e||!n||!l)return;const o=parseFloat(e.min),t=parseFloat(e.max),s=(e.value-o)/(t-o)*100,a=(n.value-o)/(t-o)*100;l.style.background=`linear-gradient(to right,
    #ddd ${s}%,
    #27ae60 ${s}%,
    #27ae60 ${a}%,
    #ddd ${a}%
  )`}function Ce(e,n,l,o,t,s,a,i,u,x,c,y,f,v){const r=document.getElementById("affichage-type-select").value==="NB"?"count":"surface",d=d3.formatLocale({decimal:",",thousands:" ",grouping:[3],currency:[""," €"]}).format(",");e.selectAll("path").data(n.features).enter().append("path").attr("d",t).style("vector-effect","non-scaling-stroke").attr("fill",p=>s(l.get(p.properties.nom.trim())?.[r]||0)).attr("stroke",k).attr("stroke-width",$).on("mouseover",(p,C)=>{const m=C.properties.nom,h=U().get(m.trim());a.style("opacity",1).html(`
        <strong>Région :</strong> ${m}<br/>
        <strong>Nombre de prairies :</strong> ${h?d(h.count):0}<br/>
        <strong>Surface de prairies :</strong> ${h?d(h.surface):0} ha<br/>
        <strong>Altitude moy. :</strong> ${h?h.avgAlt:0} m
        `),d3.select(p.currentTarget).attr("stroke","#000").attr("stroke-width",1.5).raise()}).on("mousemove",p=>{a.style("left",p.pageX+10+"px").style("top",p.pageY+10+"px")}).on("mouseout",p=>{a.style("opacity",0),d3.select(p.currentTarget).attr("stroke",k).attr("stroke-width",$)}).on("click",(p,C)=>ye(p,C,t,o,i,e,u,Z,l,a,x,c,y,f))}function de(e,n,l,o,t,s,a,i,u,x,c,y,f){n.selectAll("path").transition().duration(500).style("opacity",0).style("pointer-events","none");const v=l.features.filter(g=>o[g.properties.code]===e),r=U(),d=d3.max(v,g=>r.get(g.properties.nom.trim())?.count)||1,p=d3.max(v,g=>r.get(g.properties.nom.trim())?.surface)||1,C=document.getElementById("affichage-type-select").value,m=C==="NB"?d:p,h=C==="NB"?"Nombre de prairies":"Surface de prairies (ha)",A=C==="NB"?"count":"surface",w=d3.scaleSequential().domain([0,m]).interpolator(d3.interpolateGreens);L(s,m,h),i.selectAll("path").data(v,g=>g.properties.nom).join("path").attr("d",a).style("vector-effect","non-scaling-stroke").style("pointer-events","all").attr("fill",g=>w(r.get(g.properties.nom.trim())?.[A]||0)).attr("stroke",k).attr("stroke-width",$).style("opacity",0).on("mouseover",(g,R)=>{const P=R.properties.nom,B=U().get(P.trim());u.style("opacity",1).html(`
        <div style="font-weight:bold; font-size:15px;">${P}</div>
        <hr>
        <div><strong>Nombre de prairies :</strong> ${B?B.count:0}</div>
        <strong>Surface de prairies :</strong> ${B?B.surface:0} ha<br/>
        <div><strong>Altitude moy. :</strong> ${B?B.avgAlt:0} m</div>
      `),d3.select(g.currentTarget).attr("stroke","#000").attr("stroke-width",1.5).raise()}).on("mousemove",g=>{u.style("left",g.pageX+15+"px").style("top",g.pageY+15+"px")}).on("mouseout",g=>{u.style("opacity",0),d3.select(g.currentTarget).attr("stroke",k).attr("stroke-width",$)}).on("click",(g,R)=>{he(g,R,x,a,s,c,y,f,t,u,i)}).transition().duration(500).style("opacity",1)}function pe(e,n,l,o,t,s,a,i,u,x){l.selectAll("path").transition().duration(500).style("opacity",0).style("pointer-events","none");const c=t.features.filter(A=>A.properties.code.startsWith(e)),y=U(),f=d3.max(c,A=>y.get(A.properties.code)?.count)||1,v=d3.max(c,A=>y.get(A.properties.code)?.surface)||1,r=document.getElementById("affichage-type-select").value,d=r==="NB"?f:v,p=r==="NB"?"Nombre de prairies":"Surface de prairies (ha)",C=r==="NB"?"count":"surface",m=d3.scaleSequential().domain([0,d]).interpolator(d3.interpolateGreens);L(a,d,p),o.selectAll("path").data(c,A=>A.properties.code).enter().append("path").attr("d",i).style("vector-effect","non-scaling-stroke").attr("fill",A=>m(y.get(A.properties.code)?.[C]||0)).attr("stroke",k).attr("stroke-width",$).style("opacity",0).on("mouseover",(A,w)=>{const b=w.properties.code,g=U().get(b);u.style("opacity",1).html(`
        <div style="font-weight:bold; font-size:15px;">${b}</div>
        <hr>
        <div><strong>Nombre de prairies :</strong> ${g?g.count:0}</div>
        <div><strong>Surface de prairies :</strong> ${g?g.surface:0} ha</div>
        <div><strong>Altitude moy. :</strong> ${g?g.avgAlt:0} m</div>
      `),d3.select(A.currentTarget).attr("stroke","#000").attr("stroke-width",1.5).raise()}).on("mousemove",A=>{u.style("left",A.pageX+15+"px").style("top",A.pageY+15+"px")}).on("mouseout",A=>{u.style("opacity",0),d3.select(A.currentTarget).attr("stroke",k).attr("stroke-width",$)}).on("click",(A,w)=>Ae(A,w,n,i,a,x,o)).transition().duration(500).style("opacity",1)}function Ee(e,n,l,o,t,s,a,i,u,x,c,y){const f=d3.select("#map-container").append("button").attr("id","back-button").text("← Retour à la France").style("position","absolute").style("top","70px").style("left","20px").style("display","none").style("z-index","1000").on("click",()=>v());function v(){if(j()==="ARRONDISSEMENT"){M("DEPARTEMENT"),f.text("← Retour à la Région"),e.selectAll("path").remove();const r=ie();if(r&&(pe(r.properties.code,f,n,e,y,x,a,s,c,i),window.allParcellesData)){const d=String(parseInt(r.properties.code)),p=window.allParcellesData.filter(m=>String(parseInt(m.dep_parc))===d),C=d3.rollup(p,m=>m.length,m=>m.CODE_CULTU);F(Array.from(C,([m,h])=>({type:m,count:h})),r.properties.nom),I(p,r.properties.nom)}H(s,a,i,r,.9)}else if(j()==="DEPARTEMENT"){M("REGION"),f.text("← Retour à la France"),e.selectAll("path").remove();const r=se();if(r&&(de(r.properties.nom,o,l,t,x,a,s,n,c,f,i,e,y),window.allParcellesData)){const d=String(r.properties.code),p=window.allParcellesData.filter(m=>String(m.reg_parc).split(".")[0]===d),C=d3.rollup(p,m=>m.length,m=>m.CODE_CULTU);F(Array.from(C,([m,h])=>({type:m,count:h})),r.properties.nom),I(p,r.properties.nom)}H(s,a,i,r,.8),ae(null)}else if(j()==="REGION"){M("FRANCE"),f.style("display","none"),e.selectAll("path").remove(),n.selectAll("path").remove();const r=d3.max(u,h=>x.get(h)?.count)||100,d=d3.max(u,h=>x.get(h)?.surface)||100,p=document.getElementById("affichage-type-select").value;if(L(a,p==="NB"?r:d,p==="NB"?"Nombre de prairies":"Surface de prairies (ha)"),window.allParcellesData){const h=d3.rollup(window.allParcellesData,A=>A.length,A=>A.CODE_CULTU);F(Array.from(h,([A,w])=>({type:A,count:w})),"France"),I(window.allParcellesData,"France")}o.selectAll("path").transition().duration(500).style("opacity",1).style("pointer-events","all"),a.transition().duration(750).call(i.transform,d3.zoomIdentity),oe(null)}}return f}let K=[],D=new Map;function Ne(e,n,l,o){const t="/prairies/";Promise.all([d3.json(`${t}regions.geojson`),d3.json(`${t}departements.geojson`),d3.json(`${t}arrondissements.geojson`),d3.csv(`${t}parcelles.csv`)]).then(([s,a,i,u])=>{K=u,window.allParcellesData=u;const x=u.map(E=>+E.alt_mean).filter(E=>!isNaN(E)),c=Math.floor(d3.min(x)||0),y=Math.ceil(d3.max(x)||3e3),f=document.getElementById("alt-min-slider"),v=document.getElementById("alt-max-slider");f.min=c,f.max=y,f.value=c,v.min=c,v.max=y,v.value=y,document.getElementById("alt-min-display").innerText=c,document.getElementById("alt-max-display").innerText=y,D=ce(K,"ALL",c,y);const r=s.features.map(E=>E.properties.nom.trim()),d=d3.max(r,E=>D.get(E)?.count)||100,p=d3.max(r,E=>D.get(E)?.surface)||100,C=document.getElementById("affichage-type-select").value,m=C==="NB"?d:p,h=C==="NB"?"Nombre de prairies":"Surface de prairies (ha)",A=d3.geoConicConformal().center([2.2137,46.2276]).scale(3e3).translate([l/2,o/2]),w=d3.geoPath().projection(A),b=e.append("g"),g=b.append("g").attr("class","arr-layer"),R=b.append("g").attr("class","depts-layer"),P=b.append("g").attr("class","regions-layer"),B=d3.zoom().scaleExtent([1,40]).on("zoom",E=>b.attr("transform",E.transform)),T=d3.scaleSequential().domain([0,m]).interpolator(d3.interpolateGreens),V=Ee(g,R,a,P,Z,w,e,B,r,D,n,i);L(e,m,h),xe(d3,K,r,D,P,a,Z,e,R,i,g);const Y=d3.rollup(u,E=>E.length,E=>E.CODE_CULTU);F(Array.from(Y,([E,O])=>({type:E,count:O})),"France"),I(u,"France"),Ce(P,s,D,e,w,T,n,B,a,R,V,g,i)})}window.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("map-container"),n=e.clientWidth,l=e.clientHeight,o=d3.select("#map").append("svg").attr("width",n).attr("height",l),t=d3.select("#tooltip");Ne(o,t,n,l)});
